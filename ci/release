#!/bin/bash

set -xe

# We can deploy only when a tag is pushed, and use ir as the version
VERSION="${TRAVIS_BRANCH}-${TRAVIS_COMMIT:0:7}"
OS=${TRAVIS_OS_NAME:-linux}

[[ $OS = "linux" ]] && make cross-compile
if [[ $OS = "osx" ]]; then
  make build-gui

  iconutil -c icns -o build/mac-bundle/Coy.icns build/mac-bundle/coy.iconset

  rm -rf ./gtk-mac-bundler
  git clone https://github.com/twstrike/gtk-mac-bundler.git
  make -C gtk-mac-bundler install

  rm -rf bin/mac-bundle
  ~/.local/bin/gtk-mac-bundler build/mac-bundle/coyim.bundle

  #TODO: Investigate why this directory is duplicate
  rm -rf bin/mac-bundle/CoyIM.app/Contents/Resources/Cellar

  ln -s /Applications bin/mac-bundle/Applications
  cp build/mac-bundle/ds-store bin/mac-bundle/.DS_Store 
  ci/make-dmg coyim $VERSION bin/mac-bundle/

  rm -rf bin/mac-bundle
fi

make release-gui

# update version on bintray conf file
sed -i".bak" "s <VERSION> $VERSION g" ci/bintray.json


